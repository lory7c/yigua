# 🏗️ 易卦APP服务器架构设计

## 📐 正确的架构模式

### 整体架构
```
┌─────────────────────────────────────┐
│          Flutter APP                │
│        (纯展示层+交互)              │
└────────────┬────────────────────────┘
             │ API调用
             ↓
┌─────────────────────────────────────┐
│       Node.js API服务器             │
│         (业务逻辑层)                │
├─────────────────────────────────────┤
│  • 易经64卦查询API                  │
│  • 六爻起卦算法API                  │
│  • 梅花易数计算API                  │
│  • 周公解梦查询API                  │
│  • 老黄历查询API                    │
│  • RAG智能问答API                   │
└────────────┬────────────────────────┘
             │
    ┌────────┴────────┬──────────────┐
    ↓                 ↓              ↓
┌─────────┐    ┌──────────┐   ┌──────────┐
│SQLite   │    │Python RAG │   │Redis缓存 │
│主数据库 │    │智能引擎   │   │热数据    │
└─────────┘    └──────────┘   └──────────┘
```

## 🗄️ 服务器端数据架构

### 1. 核心数据库（SQLite/PostgreSQL）
```sql
-- 完整的64卦数据
hexagrams (64条记录)
├── id, name, symbol, number
├── judgment, image
└── interpretations (JSON)

-- 384条爻辞（64卦×6爻）
yao_texts (384条记录)
├── hexagram_id
├── position (1-6)
└── text, meaning

-- 周公解梦数据库
dreams (7000+条记录)
├── category
├── keyword
└── interpretation

-- 黄历数据
calendar_2025 (365条记录)
├── date, lunar_date
├── yi, ji (宜忌)
└── solar_terms
```

### 2. 知识图谱（Python）
```python
# RAG知识库 - 191个PDF提取的数据
knowledge_base/
├── 六爻/         # 45个文档
├── 大六壬/       # 9个文档
├── 奇门遁甲/     # 7个文档
├── 梅花易数/     # 2个文档
└── vector_db/    # 向量数据库
```

### 3. AI服务（Python）
```python
# 智能问答服务
rag_service.py
├── question_understanding()  # 问题理解
├── knowledge_retrieval()     # 知识检索
├── answer_generation()       # 答案生成
└── context_enhancement()     # 上下文增强
```

## 📱 APP端设计（轻量化）

### APP只负责：
1. **界面展示** - 显示数据
2. **用户交互** - 接收输入
3. **API调用** - 发送请求
4. **结果渲染** - 展示响应

### APP不存储：
- ❌ 完整卦象数据
- ❌ 解梦数据库
- ❌ 黄历数据
- ❌ 知识库

## 🔌 API接口设计

### 基础查询API
```javascript
// 卦象查询
GET /api/hexagrams          // 列表
GET /api/hexagrams/:id      // 详情
GET /api/hexagrams/search   // 搜索

// 占卜计算
POST /api/divination/liuyao    // 六爻起卦
POST /api/divination/meihua    // 梅花易数
POST /api/divination/qimen     // 奇门遁甲

// 解梦查询
GET /api/dreams/search?q=蛇    // 搜索梦境
GET /api/dreams/categories     // 分类列表

// 黄历查询
GET /api/calendar/today        // 今日黄历
GET /api/calendar/:date        // 指定日期
```

### 智能AI API
```javascript
// RAG智能问答
POST /api/ai/ask
{
  "question": "乾卦九五爻是什么意思？",
  "context": "business"  // 事业背景
}

// 智能解卦
POST /api/ai/interpret
{
  "hexagram": "乾",
  "changing_lines": [5],
  "question": "事业发展"
}

// 相似案例
GET /api/ai/similar-cases?hexagram=1
```

## 💾 数据部署方案

### 第1步：部署数据库
```bash
# 1. 导入64卦完整数据
python import_hexagrams.py

# 2. 导入周公解梦
python import_dreams.py  

# 3. 导入黄历
python import_calendar.py

# 4. 构建知识库
python build_knowledge_base.py
```

### 第2步：启动服务
```bash
# 启动API服务器
node server.js

# 启动Python RAG服务
python rag_server.py

# 启动Redis缓存
redis-server
```

## 🚀 优势对比

### 旧方案（离线优先）❌
- APP体积大（包含所有数据）
- 更新困难（需要发版）
- 无法使用AI功能
- 数据容易过期

### 新方案（服务器中心）✅
- APP体积小（仅UI代码）
- 实时更新（服务器端更新即可）
- 支持AI智能功能
- 数据始终最新
- 可扩展性强

## 📊 性能优化

### 1. 缓存策略
```javascript
// Redis缓存热点数据
- 64卦基本信息（永久缓存）
- 最近查询结果（1小时）
- AI回答（24小时）
```

### 2. 数据分页
```javascript
// 大数据集分页返回
GET /api/dreams?page=1&limit=20
```

### 3. 压缩传输
```javascript
// Gzip压缩
app.use(compression());
```

## 🔧 实施步骤

### Phase 1：基础API（本周）
1. ✅ 部署Node.js服务器
2. ⏳ 导入完整64卦数据
3. ⏳ 实现基础查询API
4. ⏳ APP改为API调用模式

### Phase 2：智能功能（下周）
1. 部署Python RAG服务
2. 实现智能问答API
3. 添加案例匹配功能

### Phase 3：优化扩展（第3周）
1. 添加Redis缓存
2. 实现用户系统
3. 部署到云服务器

## 💡 关键改变

**APP的定位**：
- 之前：数据容器 + 展示
- 现在：纯粹的展示终端

**服务器的定位**：
- 之前：简单的数据更新源
- 现在：核心业务引擎 + 数据中心 + AI大脑

**用户体验**：
- 需要网络连接才能使用
- 但获得更智能、更准确的结果
- 数据实时更新，功能持续增强

---

这才是正确的企业级架构！APP作为轻客户端，服务器承载所有数据和智能。