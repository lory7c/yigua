# 云端易学知识API系统架构文档

## 系统概述

本系统是一个高可用、可扩展的云端易学知识图谱和RAG系统，支持高并发访问、离线优先策略、数据同步和智能缓存。

## 核心特性

### 🚀 高性能与高可用
- **负载均衡**: Traefik自动负载均衡，支持多API实例
- **缓存策略**: Redis缓存 + Nginx反向代理缓存
- **数据库优化**: PostgreSQL主从复制，读写分离
- **容器化部署**: Docker Compose编排，支持水平扩展

### 📱 移动端优化
- **离线优先**: 本地SQLite缓存，支持离线使用
- **智能同步**: 增量数据同步，冲突自动解决
- **网络自适应**: 根据网络状态自动调整策略
- **压缩传输**: gzip压缩，减少流量消耗

### 🔍 搜索与AI功能
- **向量搜索**: Qdrant向量数据库，支持语义搜索
- **全文搜索**: Elasticsearch全文索引
- **知识图谱**: Neo4j图数据库（可选）
- **RAG问答**: 检索增强生成，智能问答

### 📊 监控与运维
- **性能监控**: Prometheus + Grafana实时监控
- **日志收集**: 统一日志管理和分析
- **健康检查**: 服务自动重启和故障转移
- **数据备份**: 自动数据库备份和恢复

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端层                              │
├─────────────────┬─────────────────┬─────────────────────────┤
│   移动端APP     │     Web前端     │      API客户端          │
│  (离线优先)     │   (实时交互)    │    (第三方集成)         │
└─────────────────┴─────────────────┴─────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│                      负载均衡层                              │
├─────────────────────────────────────────────────────────────┤
│  Traefik (负载均衡器) + Nginx (反向代理 + 静态文件)          │
└─────────────────────────────────────────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│                       API服务层                             │
├─────────────────┬─────────────────┬─────────────────────────┤
│   API Server 1  │   API Server 2  │      ...更多实例        │
│   (FastAPI)     │   (FastAPI)     │                         │
└─────────────────┴─────────────────┴─────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│                       业务逻辑层                             │
├─────────────────┬─────────────────┬─────────────────────────┤
│   数据同步服务   │   RAG问答服务   │      知识图谱服务       │
│   (增量同步)    │   (智能问答)    │    (图谱查询)           │
└─────────────────┴─────────────────┴─────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│                       数据存储层                             │
├─────────────────┬─────────────────┬─────────────────────────┤
│   PostgreSQL    │     Redis       │      Qdrant             │
│  (主要数据)     │   (缓存/队列)   │    (向量搜索)           │
├─────────────────┼─────────────────┼─────────────────────────┤
│  Elasticsearch  │     MinIO       │      本地缓存           │
│  (全文搜索)     │   (文件存储)    │    (SQLite)             │
└─────────────────┴─────────────────┴─────────────────────────┘
                            │
┌─────────────────────────────────────────────────────────────┐
│                      监控运维层                              │
├─────────────────┬─────────────────┬─────────────────────────┤
│   Prometheus    │     Grafana     │      日志系统           │
│   (指标收集)    │   (监控面板)    │    (ELK Stack)          │
└─────────────────┴─────────────────┴─────────────────────────┘
```

## 技术栈

### 后端服务
- **API框架**: FastAPI (Python 3.11+)
- **Web服务器**: Uvicorn + Gunicorn
- **异步处理**: asyncio + aiohttp
- **任务队列**: Celery + Redis

### 数据存储
- **关系数据库**: PostgreSQL 15
- **缓存**: Redis 7
- **向量数据库**: Qdrant
- **搜索引擎**: Elasticsearch 8
- **文件存储**: MinIO (S3兼容)

### 基础设施
- **容器化**: Docker + Docker Compose
- **负载均衡**: Traefik
- **反向代理**: Nginx
- **服务发现**: Docker内置网络

### 监控运维
- **监控**: Prometheus + Grafana
- **日志**: Fluentd + Elasticsearch + Kibana
- **备份**: 自动化数据库备份
- **SSL**: Let's Encrypt自动证书

## 部署指南

### 系统要求
- **操作系统**: Linux (Ubuntu 20.04+ 推荐)
- **内存**: 最少8GB，推荐16GB+
- **磁盘**: 最少50GB可用空间
- **CPU**: 最少4核，推荐8核+
- **网络**: 稳定的互联网连接

### 快速部署

1. **克隆项目**
```bash
git clone <repository-url>
cd yixue-cloud
```

2. **运行部署脚本**
```bash
./deploy.sh deploy
```

3. **检查服务状态**
```bash
./deploy.sh status
```

### 手动部署

1. **准备环境**
```bash
# 安装Docker和Docker Compose
sudo apt update
sudo apt install docker.io docker-compose

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker
```

2. **创建配置文件**
```bash
# 复制环境配置
cp .env.example .env

# 编辑配置文件
nano .env
```

3. **启动服务**
```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 检查状态
docker-compose ps
```

## API接口文档

### 认证接口
```bash
# 用户登录
POST /api/auth/login
{
  "username": "user",
  "password": "password"
}

# 刷新Token
POST /api/auth/refresh
Authorization: Bearer <token>
```

### 卦象查询
```bash
# 获取卦象详情
GET /api/hexagram/{gua_number}

# 搜索卦象
GET /api/hexagram/search?query=乾卦&limit=10
```

### 占卜服务
```bash
# 创建占卜
POST /api/divination
{
  "question": "今日运势如何？",
  "method": "liuyao",
  "hexagram_number": 1
}
```

### 知识搜索
```bash
# 知识搜索
POST /api/search/knowledge
{
  "query": "易经智慧",
  "search_type": "hybrid",
  "top_k": 10
}
```

### 智能问答
```bash
# 问答接口
POST /api/qa
{
  "question": "什么是太极？",
  "context_type": "auto"
}
```

## 数据同步方案

### 同步策略
- **增量同步**: 只同步变更数据，减少网络传输
- **冲突解决**: 自动检测并解决数据冲突
- **版本控制**: 完整的数据版本历史记录
- **压缩传输**: gzip压缩，节省带宽

### 同步流程
```
客户端 → 检查网络状态 → 发起同步请求 → 服务端处理
    ↓                                        ↓
本地缓存 ← 应用更新 ← 解决冲突 ← 返回增量数据
```

### 离线支持
- **本地缓存**: SQLite存储常用数据
- **离线队列**: 离线操作缓存，联网后同步
- **智能缓存**: 根据使用频率自动缓存热点数据

## 移动端集成

### 客户端SDK
```python
from api.mobile_api_client import create_mobile_client

# 创建客户端
client = create_mobile_client("https://api.yixue.com")

# 设置认证
await client.login("username", "password")

# 查询卦象
hexagram = await client.get_hexagram(1)

# 智能问答
answer = await client.ask_question("什么是易经？")

# 离线支持
stats = client.get_cache_stats()
```

### 缓存策略
- **CACHE_FIRST**: 优先使用缓存
- **NETWORK_FIRST**: 优先网络请求
- **CACHE_ONLY**: 仅使用缓存
- **NETWORK_ONLY**: 仅网络请求

## 监控与运维

### 关键指标监控
- **系统指标**: CPU、内存、磁盘、网络
- **应用指标**: 响应时间、并发数、错误率
- **业务指标**: API调用量、用户活跃度、功能使用情况

### 告警设置
- **服务不可用**: 立即告警
- **响应时间超标**: 1分钟内告警
- **错误率过高**: 5分钟内告警
- **资源使用率**: 15分钟内告警

### 日志管理
- **结构化日志**: JSON格式，便于分析
- **分级记录**: ERROR、WARN、INFO、DEBUG
- **集中收集**: 统一日志管理平台
- **实时分析**: 支持实时日志搜索和分析

## 安全措施

### 认证授权
- **JWT Token**: 无状态认证
- **角色权限**: 基于角色的访问控制
- **API限流**: 防止API滥用
- **HTTPS**: 全链路加密传输

### 数据安全
- **数据加密**: 敏感数据加密存储
- **访问控制**: 最小权限原则
- **审计日志**: 完整的操作记录
- **备份加密**: 备份数据加密保护

## 性能优化

### 缓存策略
```
L1缓存(内存) → L2缓存(Redis) → L3缓存(本地) → 数据库
   1ms           10ms           100ms      1000ms
```

### 数据库优化
- **索引优化**: 针对查询模式优化索引
- **读写分离**: 主库写入，从库查询
- **连接池**: 复用数据库连接
- **查询缓存**: 缓存热点查询结果

### CDN加速
- **静态资源**: 图片、CSS、JS文件CDN分发
- **API缓存**: 可缓存API响应CDN缓存
- **全球节点**: 就近访问，降低延迟

## 扩展方案

### 水平扩展
- **API服务**: 无状态设计，可随意扩展实例
- **数据库**: 读副本扩展，分库分表
- **缓存**: Redis集群模式
- **存储**: 分布式文件系统

### 垂直扩展
- **服务器**: 增加CPU、内存、磁盘
- **数据库**: 优化配置参数
- **网络**: 提升带宽和网络质量

## 成本分析

### 基础配置成本（月）
- **云服务器**: $50-100 (4核8GB)
- **数据库**: $30-60 (托管PostgreSQL)
- **存储**: $10-20 (100GB)
- **CDN**: $5-15 (1TB流量)
- **监控**: $0-20 (开源方案)

### 优化建议
- 使用预留实例节省成本
- 合理配置自动扩缩容
- 定期清理无用资源
- 监控成本变化趋势

## 故障处理

### 常见问题
1. **API响应慢**: 检查数据库连接、缓存状态
2. **服务不可用**: 检查容器状态、网络连接
3. **数据同步失败**: 检查网络、权限、数据格式
4. **内存不足**: 增加服务器内存或优化程序

### 应急预案
- **服务降级**: 关闭非核心功能
- **流量限制**: 临时限制访问频率
- **数据备份**: 立即备份重要数据
- **故障转移**: 切换到备用系统

## 联系信息

- **技术支持**: tech@yixue.com
- **文档地址**: https://docs.yixue.com
- **API控制台**: https://console.yixue.com
- **状态页面**: https://status.yixue.com